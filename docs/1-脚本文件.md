## ç›®å½•ç»“æ„

``` sh
.
â”œâ”€â”€ cluster-demo-setting
â”‚Â Â  â”œâ”€â”€ 3node-demo.yaml
â”‚Â Â  â””â”€â”€ ingress-cluster-demo.yaml
â””â”€â”€ kind-tool.sh
```

## ç®€å•ä½¿ç”¨

``` sh
# è¿›å…¥é˜²æ­¢ kind-tool.sh çš„ç›®å½•
$ cd kt-dir/
# ç”¨ alias ç»™ä¸ªåˆ«åï¼Œæ›´ä¾¿äºä½¿ç”¨
$ alias kt="./kind-tool.sh"
# æ°¸ä¹…ç”Ÿæ•ˆ æ­¤å¤„æŠŠ ./kind-tool.sh æ¢ä¸ºç»å¯¹è·¯å¾„
# zsh  
echo 'alias kt="./kind-tool.sh"' >> ~/.zshrc
source ~/.zshrc
# bash
echo 'alias kt="./kind-tool.sh"' >> ~/.bashrc
source ~/.bashrc



# åˆ›å»ºå•èŠ‚ç‚¹é›†ç¾¤ï¼Œæ­¤ç§é»˜è®¤é‡‡ç”¨æœ€æ–°ç‰ˆæœ¬é•œåƒ
$ kt create single-node-cluster
# æŒ‡å®š k8s é•œåƒç‰ˆæœ¬
$ kt create single-node-cluster --image kindest/node:v1.24.5
# é‡‡ç”¨ é»˜è®¤ç‰ˆæœ¬ï¼ˆç›®å‰é…ç½®ä¸º  kindest/node:v1.24.3 ï¼‰â€”â€”  k8s 1.24.3 ç‰ˆæœ¬
$ kt create single-node-cluster --default

# æŸ¥çœ‹ç›®å‰é…ç½®çš„å¤šèŠ‚ç‚¹é›†ç¾¤æ¨¡æ¿
$ kt cds list
ğŸ” Listing all available templates:
- 3node-demo
- ingress-cluster-demo

# åˆ›å»º 3 èŠ‚ç‚¹çš„é›†ç¾¤
$ kt create 3-node-cluster --image kindest/node:v1.24.3 --config 3node-demo

# æŸ¥çœ‹å½“å‰æ‰€æœ‰é›†ç¾¤
$ kt list

# åˆ é™¤é›†ç¾¤
$ kt delete 3-node-cluster

# åŠ è½½æŒ‡å®šé•œåƒåˆ°æŒ‡å®šé›†ç¾¤
$ kt load 3-node-cluster busybox:latest


# æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
$ kt -h
Usage: ./kind-tool.sh [command] [options]
Commands:
  create <cluster-name> [--image <image>] [--config <template>] [--default]  Create a new Kind cluster
    sub-args:
      --image <image>                   Create a cluster using the image you specified
      --config <template>               Template is used to configure the architecture of the cluster (multi node or port exposure)
      --default                         Create a cluster using the default image version (k8s 1.24.3)
  delete <cluster-name>                 Delete the Kind cluster
  export-kubeconfig <cluster-name>      Export Kubeconfig for cluster, Short command(ek)
  load-image <cluster-name> <image>     Load Docker image into Kind cluster, Short command(load)
  status <cluster-name>                 Get cluster status
  list                                  List all existing Kind clusters
  use <cluster-name>                    Switch to the specified Kind cluster
  cluster-demo-setting <subcommand> [options]  Short command(cds for cluster-demo-setting)
    subcommands:
      list                              List all supported templates
      show <template-name>              Show the content of a specific template
  help                                  Display this help message
```



## è„šæœ¬

``` sh
#!/bin/bash

# é…ç½®
KUBECONFIG_PATH="./"
WITH_METRICS=false
WITH_INGRESS=false
LOAD_IMAGE=false
DEFAULT_IMAGE="kindest/node:v1.24.3"  # é»˜è®¤é•œåƒ

# æ˜¾ç¤ºå‹¾é€‰æˆ–å‰
checkmark="âœ…"
crossmark="âŒ"

# é…ç½®åˆ° shell ä¸­ï¼Œä¸ºäº†ä¾¿æ·ä½¿ç”¨
# echo 'alias kt="./kind-tool.sh"' >> ~/.zshrc
# source ~/.zshrc

# æ¨¡æ¿é…ç½® è·¯å¾„è·å–
SCRIPT_DIR="$(dirname "$0")"
TEMPLATES_DIR="$SCRIPT_DIR/cluster-demo-setting"
DEFAULT_TEMPLATE="ingress-cluster-demo"
# è®¾ç½®æ–‡ä»¶å¤¹è·¯å¾„
Cluster_Config_DIR="$SCRIPT_DIR/clusters-kind-config"



# æ‰“å°å¸®åŠ©ä¿¡æ¯
usage() {
  echo "Usage: $0 [command] [options]"
  echo "Commands:"
  echo "  create <cluster-name> [--image <image>] [--config <template>] [--default]  Create a new Kind cluster"
  echo "    sub-args:"
  echo "      --image <image>                   Create a cluster using the image you specified "
  echo "      --config <template>               Template is used to configure the architecture of the cluster (multi node or port exposure)"
  echo "      --default                         Create a cluster using the default image version (k8s 1.24.3)"
  echo "  delete <cluster-name>                 Delete the Kind cluster"
  echo "  export-kubeconfig <cluster-name>      Export Kubeconfig for cluster, Short command(ek)"
  echo "  load-image <cluster-name> <image>     Load Docker image into Kind cluster, Short command(load)"
  echo "  status <cluster-name>                 Get cluster status"
  echo "  list                                  List all existing Kind clusters"
  echo "  use <cluster-name>                    Switch to the specified Kind cluster"
  echo "  cluster-demo-setting <subcommand> [options]  Short command(cds for cluster-demo-setting)"
  echo "    subcommands:"
  echo "      list                              List all supported templates"
  echo "      show <template-name>              Show the content of a specific template"
  echo "  help                                  Display this help message"
  exit 1
}

# æ£€æŸ¥æ˜¯å¦å®‰è£… kind å’Œ kubectl
command -v kind &>/dev/null || { echo "Kind is not installed!"; exit 1; }
command -v kubectl &>/dev/null || { echo "kubectl is not installed!"; exit 1; }

# æ‰“å°å‘½ä»¤å¹¶æ‰§è¡Œ
run_command() {
  echo "-------- Command Info -------"
  echo "Executing: $1"
  echo "<-------- Command Result ------->"
  eval "$1"
  echo " "
}

# åŠ è½½æŒ‡å®šæ¨¡æ¿é…ç½®
load_template() {
  TEMPLATE_NAME=$1
  TEMPLATE_FILE="$TEMPLATES_DIR/$TEMPLATE_NAME.yaml"

  if [ ! -f "$TEMPLATE_FILE" ]; then
    echo "Error: Template '$TEMPLATE_NAME' not found!"
    exit 1
  fi

  echo "#Using template '$TEMPLATE_NAME' from $TEMPLATE_FILE..."
  cat "$TEMPLATE_FILE"
  echo
}

# åˆ›å»ºé›†ç¾¤
create_cluster() {
  CLUSTER_NAME=$1
  IMAGE=
  TEMPLATE=

  shift # ç§»é™¤ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆé›†ç¾¤åç§°ï¼‰
  
  # è§£æå‘½ä»¤è¡Œå‚æ•°
  while [[ "$#" -gt 0 ]]; do
    case $1 in
      --image) IMAGE="$2"; shift 2 ;;
      --config) TEMPLATE="$2"; shift 2 ;;
      --default) IMAGE=$DEFAULT_IMAGE; shift ;;
      *) echo "Unknown parameter: $1"; usage ;;
    esac
  done

  echo "ğŸš€ Creating Kind cluster: $CLUSTER_NAME with image: $IMAGE and template: $TEMPLATE..."

  # æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
  if [ ! -d "$Cluster_Config_DIR" ]; then
    mkdir "$Cluster_Config_DIR"
  fi

  # åŠ è½½æ¨¡æ¿
  if [ -n "$TEMPLATE" ]; then
    # åœ¨ Shell ä¸­ï¼Œç­‰å·ä¸¤è¾¹ä¸èƒ½æœ‰ç©ºæ ¼ã€‚æ­£ç¡®çš„èµ‹å€¼æ–¹å¼æ˜¯ï¼š
    # åœ¨ Shell è„šæœ¬ä¸­ï¼Œä½¿ç”¨ export åˆ›å»ºçš„ç¯å¢ƒå˜é‡æ˜¯åªåœ¨è„šæœ¬è¿è¡Œæ—¶æœ‰æ•ˆçš„ï¼Œé€€å‡ºè„šæœ¬åç¯å¢ƒå˜é‡å°†ä¸ä¼šåœ¨å½“å‰çš„ç»ˆç«¯ä¼šè¯ä¸­å­˜åœ¨
    export KT_CLUSTER_NAME="$CLUSTER_NAME"
    USER_CLUSTER_FILE="$Cluster_Config_DIR/$CLUSTER_NAME-kind-config.yaml"
    load_template "$TEMPLATE" > "$USER_CLUSTER_FILE"
    # åœ¨ macOS ä¸Šï¼Œsed -i éœ€è¦åŠ ç©ºå­—ç¬¦ä¸² ''ï¼ˆè¿™æ˜¯ macOS ä¸Š sed çš„è¦æ±‚ï¼‰ï¼Œè€Œåœ¨ Linux ä¸Šï¼Œç›´æ¥ sed -i å°±å¯ä»¥ã€‚
    # æ–¹æ³•2ï¼šå¯ä»¥é€šè¿‡ envsubst æ¥æ›¿æ¢é…ç½®æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡
    # envsubst < 3node-template > 3node-template.tmpï¼šå°†æ¨¡æ¿æ–‡ä»¶å†…å®¹é€šè¿‡ envsubst è¿›è¡Œæ›¿æ¢ï¼Œå¹¶å°†æ›¿æ¢åçš„å†…å®¹è¾“å‡ºåˆ°ä¸´æ—¶æ–‡ä»¶ 3node-template.tmp ä¸­
    sed -i '' -e "s/\${KT_CLUSTER_NAME}/$KT_CLUSTER_NAME/g" -e "s/\${NODE_IMAGE}/$NODE_IMAGE/g" "$USER_CLUSTER_FILE"
    CONFIG="--config $Cluster_Config_DIR/$CLUSTER_NAME-kind-config.yaml"
  fi

  # æ‰“å°å¹¶æ‰§è¡Œåˆ›å»ºé›†ç¾¤å‘½ä»¤
  if [ -n "$CONFIG" ] && [ -n "$IMAGE" ]; then
    run_command "kind create cluster --name \"$CLUSTER_NAME\" --image \"$IMAGE\" $CONFIG"
  elif [ -n "$CONFIG" ]; then
    run_command "kind create cluster --name \"$CLUSTER_NAME\" $CONFIG"
  elif [ -n "$IMAGE" ]; then
    run_command "kind create cluster --name \"$CLUSTER_NAME\" --image \"$IMAGE\""
  else
    run_command "kind create cluster --name \"$CLUSTER_NAME\""
  fi

  # å¦‚æœéœ€è¦å®‰è£… metrics-server
  if $WITH_METRICS; then
    echo "ğŸ“Š Installing metrics-server..."
    run_command "kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml"
  fi

  # å¦‚æœéœ€è¦å®‰è£… ingress-nginx
  if $WITH_INGRESS; then
    echo "ğŸŒ Installing ingress-nginx..."
    run_command "kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml"
  fi

  echo "âœ… Cluster created successfully!"
}

# åˆ‡æ¢é›†ç¾¤
use_cluster() {
  CLUSTER_NAME=$1
  echo "ğŸ”„ Switching to Kind cluster: $CLUSTER_NAME..."
  run_command "kubectl config use-context kind-$CLUSTER_NAME"
  echo "âœ… Switched to $CLUSTER_NAME."
}

# å¯¼å‡º kubeconfig æ–‡ä»¶
export_kubeconfig() {
  CLUSTER_NAME=$1
  echo "ğŸ“¤ Exporting kubeconfig to $KUBECONFIG_PATH..."

  # æ‰“å°å¹¶æ‰§è¡Œå¯¼å‡º kubeconfig å‘½ä»¤
  KUBECONFIG_FILE="./$CLUSTER_NAME-kubeconfig"
  run_command "kind get kubeconfig --name \"$CLUSTER_NAME\" > \"$KUBECONFIG_FILE\""

  echo "âœ… Kubeconfig exported!"
}


# åŠ è½½ Docker é•œåƒåˆ° Kind é›†ç¾¤
load_image() {
  CLUSTER_NAME=$1
  IMAGE_TAG=$2
  echo "ğŸ’¾ Loading Docker image '$IMAGE_TAG' into Kind cluster '$CLUSTER_NAME'..."

  # æ‰“å°å¹¶æ‰§è¡ŒåŠ è½½é•œåƒå‘½ä»¤
  run_command "kind load docker-image \"$IMAGE_TAG\" --name \"$CLUSTER_NAME\""

  echo "âœ… Image loaded successfully!"
}


# å¥åº·æ£€æŸ¥å‡½æ•°
health_check() {
  echo "ğŸ§  Running health check for the cluster..."

  echo -n "ğŸ§© Nodes reachable: "
  run_command "kubectl get nodes &>/dev/null && echo \"$checkmark\" || echo \"$crossmark\""

  echo -n "ğŸ“ˆ Metrics-server running: "
  run_command "kubectl get deployment metrics-server -n kube-system &>/dev/null && echo \"$checkmark\" || echo \"$crossmark\""

  echo -n "ğŸŒ Ingress controller running: "
  run_command "kubectl get pods -n ingress-nginx &>/dev/null && echo \"$checkmark\" || echo \"$crossmark\""

  echo -n "ğŸ§ª Demo app deployed: "
  run_command "kubectl get deploy demo &>/dev/null && echo \"$checkmark\" || echo \"$crossmark\""

  echo -n "ğŸ›°ï¸ Ingress route configured: "
  run_command "kubectl get ingress demo-ingress &>/dev/null && echo \"$checkmark\" || echo \"$crossmark\""
}

# å¤„ç†é›†ç¾¤æ¨¡æ¿è®¾ç½®å‘½ä»¤
cluster_demo_setting() {
  if [[ "$1" == "list" ]]; then
    echo "ğŸ” Listing all available templates:"
    for template in "$TEMPLATES_DIR"/*.yaml; do
      echo "- $(basename "$template" .yaml)"
    done
  elif [[ "$1" == "show" ]]; then
    if [[ -z "$2" ]]; then
      echo "Error: Template name is required!"
      exit 1
    fi
    load_template "$2"
  else
    echo "Unknown subcommand: $1"
    usage
  fi
}

# é›†ç¾¤å‘½ä»¤æ‰§è¡Œ
case "$1" in
  "create")
    if [ -z "$2" ]; then
      echo "Cluster name is required!"
      usage
    fi
    # ${@:2} è¡¨ç¤ºä»å¿½ç•¥ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¼ å…¥å…¶ä½™æ‰€æœ‰å‚æ•°
    create_cluster "${@:2}"
    ;;
  "list")
    echo "ğŸ” Listing all existing Kind clusters..."
    run_command "kind get clusters"
    run_command "kubectl config get-contexts"
    run_command "kubectl config current-context"
    ;;
  "delete")
    if [ -z "$2" ]; then
      echo "Cluster name is required!"
      usage
    fi
    echo "ğŸ—‘ï¸ Deleting Kind cluster: $2..."
    run_command "kind delete cluster --name \"$2\""
    ;;
  "status")
    if [ -z "$2" ]; then
      echo "Cluster name is required!"
      usage
    fi
    echo "ğŸ” Checking cluster status..."
    run_command "kind get clusters | grep -q \"$2\" && echo \"$checkmark Cluster exists: $2\" || echo \"$crossmark Cluster does not exist.\""
    ;;
  "use")
    if [ -z "$2" ]; then
      echo "Cluster name is required to switch!"
      usage
    fi
    use_cluster "$2"
    ;;
  "load"|"load-image")
    if [ -z "$2" ] || [ -z "$3" ]; then
      echo "Both cluster name and image tag are required!"
      usage
    fi
    load_image "$2" "$3"
    ;;
  "ek"|"export-kubeconfig")
    if [ -z "$2" ]; then
     echo "Cluster name is required!"
     usage
    fi
    export_kubeconfig "$2"
    ;;
  "health-check")
    health_check
    ;;
  "cds"|"cluster-demo-setting")
    cluster_demo_setting "${@:2}"
    ;;
  "-h"|"--help"|"help")
    usage
    ;;
  *)
    usage
    ;;
esac

```



## é›†ç¾¤æ¨¡æ¿ç›®å½•

- è„šæœ¬åŒçº§ç›®å½•åˆ›å»º`cluster-demo-setting` ç›®å½•
- æ·»åŠ ä¸ªç®€å•çš„é›†ç¾¤å®ä¾‹

``` sh
# æ·»åŠ æ–‡ä»¶ 3node-demo.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
  - role: control-plane
  - role: worker
  - role: worker
```

